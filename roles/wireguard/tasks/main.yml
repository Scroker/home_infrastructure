---
- name: Install and condfigure wireguard
  become: true
  block:
  - name: Install wireguard
    ansible.builtin.dnf:
      name:
        - wireguard-tools
      state: present

  - name: Ensure /etc/wireguard directory exists
    ansible.builtin.file:
      path: /etc/wireguard
      state: directory
      owner: root
      group: root
      mode: '0700'

  - name: Configure WireGuard interface
    ansible.builtin.template:
      src: templates/wg0.conf.j2
      dest: /etc/wireguard/wg0.conf
      owner: root
      group: root
      mode: '0600'

  - name: Enable and start WireGuard service
    ansible.builtin.systemd_service:
      name: wg-quick@wg0
      enabled: yes
      state: started

  - name: Permit traffic on wireguard service
    ansible.posix.firewalld:
      service: wireguard
      permanent: true
      immediate: true
      state: enabled

  - name: Add wg0 interface to the internal zone
    ansible.posix.firewalld:
      interface: wg0
      zone: internal
      permanent: yes
      immediate: true
      state: enabled

  - name: Enable ipv4 forward
    ansible.posix.sysctl:
      name: net.ipv4.ip_forward
      value: '1'
      sysctl_set: true
      state: present
      reload: true

  - name: Enable ipv6 forward
    ansible.posix.sysctl:
      name: net.ipv6.conf.all.forwarding
      value: '1'
      sysctl_set: true
      state: present
      reload: true
---
- name: General server setup
  hosts: gateway, server
  pre_tasks:

    - name: Imposta il nuovo hostname
      ansible.builtin.hostname:
        name: "{{ hostname }}.private"

    - name: Imposta l'hostname Pretty
      ansible.builtin.command:
        cmd: "hostnamectl set-hostname --pretty '{{ hostname }}'"
      changed_when: true

    - name: Aggiorna il file /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ hostname }}.private"
        owner: root
        group: root
        mode: '0644'

- name: Setup VPN and Reverse Proxy
  hosts: gateway, client, server
  gather_facts: true
  pre_tasks:
    - name: Generate wireguard keys
      ansible.builtin.import_tasks: tasks/generate_wireguard_keys.yml
  roles:
    - wireguard

- name: Setup dnsmasq service
  hosts: gtw01
  roles:
    - dnsmasq

---
- name: Distruzione totale del Cluster Kubernetes
  become: true
  block:
    - name: Esegui kubeadm reset
      ansible.builtin.command: |
        kubeadm reset -f
      changed_when: true

    - name: Ferma i servizi
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - kubelet
        - crio

    - name: Rimuovi pacchetti e configurazioni di rete
      ansible.builtin.command: >-
          iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X &&
          ip link delete cni0 || true &&
          ip link delete flannel.1 || true &&
      changed_when: true
      failed_when: false

    - name: Rimuovi directory residue
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/etcd
        - /var/lib/kubelet
        - /var/lib/cni
        - /etc/cni
        - "{{ ansible_facts['env']['HOME'] }}/.kube"

    - name: Riavvia CRI-O per pulire i container residui
      ansible.builtin.systemd:
        name: crio
        state: started

- name: Configuration of the Kubernetes Control Plane
  become: true
  block:

    - name: Inizializzazione del Cluster Kubernetes
      ansible.builtin.command: >-
        kubeadm init
          --apiserver-advertise-address={{ vpn_ip }}
          --apiserver-cert-extra-sans={{ vpn_ip }}
          --node-name server01.private
          --pod-network-cidr={{ pod_network_cidr }}
          --cri-socket=unix:///var/run/crio/crio.sock
      changed_when: true
      register: kubernetes_control_plane_output

    - name: Crea la cartella .kube nella home dell'utente
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Copia admin.conf
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Installazione del Network Plugin (Flannel)
      become: false
      ansible.builtin.command: |
        kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      changed_when: true

    - name: Forza Flannel a usare l'interfaccia Wireguard
      become: false
      ansible.builtin.command: |
        kubectl patch ds kube-flannel-ds
          -n kube-flannel
          --type='json'
          -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--iface={{ vpn_ip }}"}]'
      changed_when: true

    - name: Genera il comando di join
      ansible.builtin.command: kubeadm token create --print-join-command
      register: kubernetes_control_plane_join_command_raw
      changed_when: false

    - name: Imposta il comando di join come fact
      ansible.builtin.set_fact:
        kubernetes_control_plane_join_command: "{{ kubernetes_control_plane_join_command_raw.stdout }}"
